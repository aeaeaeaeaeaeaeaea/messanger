<!DOCTYPE html>
<html>

<head>
	<meta charset="UTF-8">

	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
		integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
	<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>

	<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>

	<style>
		.my-message {
			background-color: lightblue;
			padding: 5px;
			margin: 5px;
			border-radius: 5px;
			clear: both;
		}

		.other-message {
			background-color: lightgreen;
			padding: 5px;
			margin: 5px;
			border-radius: 5px;
			float: left;
			clear: both;
		}
	</style>

</head>

<body class="d-flex flex-column min-vh-100">

	<!-- Start -->

	<div class="container-fluid">
		<div class="row">

			<!-- Список чатов -->
			<div class="col-3 mt-2">

				<!-- Форма для поиска -->
				<form class="col-8" action="/users" method="GET">
					<input class="form-control" type="text" name="userName" placeholder="Search" />
				</form>

				<div class="mt-2">

					<div th:each="chatRoom : ${chatList}">

						<div th:if="${chatRoom.getRecipientId().equals(currentUser)}">

							<a  
							    class="chat-link list-group-item list-group-item-action" 
								id="link"
								th:data="${chatRoom.getId()}" 
								th:href="@{/chat/{chatId}(chatId = ${chatRoom.getId()})}"
							>

								<div class="d-flex w-100 justify-content-between">
									<h5 class="mb-1" th:text="${chatRoom.getSenderName()}">text</h5>

									<div th:if="${lastMessages.get(chatRoom.getId()).getContent() != null}">

										<small
											th:if="${todayDate.equals(lastMessages.get(chatRoom.getId()).getSendTime().format(formatter))}"
											th:text="${lastMessages.get(chatRoom.getId()).getSendTime().format(todayFormat)}">
											text
										</small>

										<small
											th:if="${!todayDate.equals(lastMessages.get(chatRoom.getId()).getSendTime().format(formatter))}"
											th:text="${lastMessages.get(chatRoom.getId()).getSendTime().format(formatter)}">
											text
										</small>

									</div>

								</div>


								<p th:if="${lastMessages.get(chatRoom.getId()).getContent() != null}" class="mb-1"
									th:text="${lastMessages.get(chatRoom.getId()).getContent()}">
									text
								</p>

							</a>

						</div>

						<div th:if="${!chatRoom.getRecipientId().equals(currentUser)}">

							<a class="chat-link list-group-item list-group-item-action" id="link"
								th:data="${chatRoom.getId()}" th:href="@{/chat/{chatId}(chatId = ${chatRoom.getId()})}">

								<div class="d-flex w-100 justify-content-between">
									<h5 class="mb-1" th:text="${chatRoom.getRecipientName()}">text</h5>

									<div th:if="${lastMessages.get(chatRoom.getId()).getContent() != null}">

										<small
											th:if="${todayDate.equals(lastMessages.get(chatRoom.getId()).getSendTime().format(formatter))}"
											th:text="${lastMessages.get(chatRoom.getId()).getSendTime().format(todayFormat)}">
											text
										</small>

										<small
											th:if="${!todayDate.equals(lastMessages.get(chatRoom.getId()).getSendTime().format(formatter))}"
											th:text="${lastMessages.get(chatRoom.getId()).getSendTime().format(formatter)}">
											text
										</small>

									</div>

								</div>


								<p th:if="${lastMessages.get(chatRoom.getId()).getContent() != null}" class="mb-1"
									th:text="${lastMessages.get(chatRoom.getId()).getContent()}">
									text
								</p>


							</a>

						</div>


					</div>

				</div>
			</div>


			<!-- Вывод сообщений -->
			<div class="col" style="background-color: rgb(231, 232, 230); height: 100vh">


				<div class="row align-items-end">
					<div id="message-container" style="overflow: scroll; height: 95vh; 
						 max-height: 95vh; background-color: #e6e8e9; 
						 overflow-x: hidden;">

						<div th:each="cassandraMessage : ${cassandraMessages}">
							<div class="message-container"
								th:classappend=
								"${cassandraMessage.getSenderId() == currentUser ? 'my-message' : 'other-message'}">
								
								<p 	
								
									th:text="${cassandraMessage.getContent()}" 
									
									id="message"
									th:sendtime="${cassandraMessage.getSendTime()}"
									th:messageId="${cassandraMessage.getId()}"
									th:chatId="${cassandraMessage.getChatId()}"
									
									class="message-content"
								></p>
								
							</div>
						</div>

						<div th:each="cachedMessage : ${cachedMessages}">
							<div class="message-container"
								th:classappend="${cachedMessage.getSenderId() == currentUser ? 'my-message' : 'other-message'}">
								<p 
									
									th:text="${cachedMessage.getContent()}" 
									
									id="message"
									th:sendtime="${cachedMessage.getSendTime()}"
									th:messageId="${cachedMessage.getId()}"
									th:chatId="${cachedMessage.getChatId()}">
									
								</p>
							</div>
						</div>

					</div>
				</div>

				<div class="col" style="position: absolute; bottom: 0;">


					<form  id="messageForm">
						
						<input
							style="width: 100%;"
							type="text" id="messageInput" 
							
							th:data="${id}"
							th:dataSenderId="${currentUser}"
							
							placeholder="Type your message..." 
						/>
				
					</form>

					<!-- Форма для редактирования сообщения -->
					<div id="editForm" style="display: none;">
						<form id="messageEditForm" action="/editMessage" method="post">

							<input type="hidden" name="messageId" id="editMessageId" value="">
							<input type="hidden" name="chatId" id="editChatId" value="">
							<input type="text" name="editedContent" id="editedContent"
								placeholder="Редактировать сообщение">

							<button type="submit">Сохранить изменения</button>
						</form>
					</div>


				</div>


			</div>

			<!-- Модальное окно -->
			<div id="myModal" class="modal" style="display: none;">
				<div class="modal-content">
					<span class="close">&times;</span>
					<p>Выберите действие:</p>
					<button id="deleteButton">Удалить</button>
					<button id="editButton">Редактировать</button>
				</div>
			</div>

		</div>


	</div>

	<script src="/js/messageScripts/messageScroll.js"></script>
	<script src="/js/messageScripts/messageContextMenuEdit.js"></script>
	<script src="/js/messageScripts/messageEditOrDelete.js"></script>
	<script src="/js/messageScripts/webSocket.js"></script>
	<script src="/js/messageScripts/messageColor.js"></script>


</body>

</html>